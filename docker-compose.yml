services:
    # MongoDB 資料庫
    mongodb:
        image: mongo:7.0
        container_name: self-learning-mongodb
        restart: unless-stopped
        ports:
            - "27017:27017"
        environment:
            MONGO_INITDB_DATABASE: self_learning_system
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        networks:
            - self-learning-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/self_learning_system --quiet
            interval: 10s
            timeout: 5s
            retries: 5

    # FastAPI 後端應用
    backend:
        build:
            context: .
            dockerfile: backend/Dockerfile
        container_name: self-learning-backend
        restart: unless-stopped
        ports:
            - "8000:8000"
        environment:
            - MONGODB_URL=mongodb://mongodb:27017
            - MONGODB_DB_NAME=self_learning_system
            - DEBUG=True
            - SECRET_KEY=your-secret-key-change-in-production
        volumes:
            - ./backend/uploads:/app/uploads
            # 開發時啟用熱過載（可選）
            # - ./backend/app:/app/app
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - self-learning-network
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 120s

    # React 前端應用（Nginx）
    frontend:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: self-learning-frontend
        restart: unless-stopped
        ports:
            - "3000:3000"
        depends_on:
            backend:
                condition: service_healthy
        networks:
            - self-learning-network
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
            interval: 30s
            timeout: 10s
            retries: 3

volumes:
    mongodb_data:
        driver: local
    mongodb_config:
        driver: local

networks:
    self-learning-network:
        driver: bridge
